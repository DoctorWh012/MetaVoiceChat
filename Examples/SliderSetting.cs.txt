using Assets.Metater;
using R3;
using TMPro;
using UnityEngine;
using UnityEngine.UI;

public class SliderSetting : MetaMb<SliderSetting>, IInitableSetting
{
    public SerializableReactiveProperty<int> value = new(0);

    [Header("Settings")]
    public int defaultValue = 100;
    public string units = "%";

    [Header("UI")]
    public TMP_Text text;
    public Slider slider;
    public Button resetButton;

    private string PlayerPrefsKey => name;

    private bool isInit = false;

    private void Awake()
    {
        slider.onValueChanged.AddListener(OnSliderValueChanged);
        resetButton.onClick.AddListener(OnResetButtonClicked);

        Init();
    }

    private void OnSliderValueChanged(float v)
    {
        value.Value = Mathf.RoundToInt(v);
    }

    private void OnResetButtonClicked()
    {
        value.Value = defaultValue;

        AudioSystem.Instance.PlayClickSfx();
    }

    private string GetText(int value)
    {
        return $"{PlayerPrefsKey}: {value}{units}";
    }

    public void Init()
    {
        if (isInit)
        {
            return;
        }

        isInit = true;

        value.Value = PlayerPrefs.GetInt(PlayerPrefsKey, defaultValue);

        value.Subscribe(v =>
        {
            slider.SetValueWithoutNotify(v);
            text.text = GetText(v);
            PlayerPrefs.SetInt(PlayerPrefsKey, v);
        }).AddTo(this);
    }
}
